<div class="dashboard-container">
  <div class="chat-list box">
    <div class="chat-header-row enhanced">
      <button class="status-btn" (click)="toggleOnlineStatus()">
        <span
          class="status-dot"
          [class.online]="getMyOperatorOnlineStatus()"
        ></span>
        <span>{{ getMyOperatorOnlineStatus() ? "Online" : "Offline" }}</span>
      </button>

      <div class="select-wrapper">
        <select [(ngModel)]="chatSortMode" (change)="applySort()">
          <option value="latest">Recenti</option>
          <option value="priority">Priorità</option>
        </select>
      </div>
    </div>

    <ul class="chat-dot-list">
      <li
        *ngFor="let chat of chats$ | async"
        (click)="selectChat(chat.id)"
        [class.active]="chat.id === selectedChatId"
        [title]="chat.id"
        class="chat-entry"
      >
        <div class="dot">{{ chat.id | slice : 0 : 2 }}</div>
        <span *ngIf="chat.unreadByOperator" class="chat-badge"></span>
      </li>
    </ul>
  </div>

  <!-- Chat detail: dimensionabile -->
  <div class="chat-detail box" [style.flexBasis.%]="chatDetailWidth">
    <div class="chat-header" *ngIf="selectedChatId">
      <div class="chat-user">
        🧑‍💻 <strong>{{ selectedChatId }}</strong>
      </div>
      <div class="chat-controls">
        <button
          class="chat-btn bell-toggle"
          (click)="toggleNotification(selectedChatId)"
          [class.active]="currentChatHasUnread"
          title="Toggle notifica"
        >
          🔔
        </button>
        <button class="chat-btn archive" (click)="archiveChat(selectedChatId)">
          Archivia
        </button>
        <button class="chat-btn delete" (click)="deleteChat(selectedChatId)">
          Elimina
        </button>
      </div>
    </div>
    <app-chat-window [chatId]="selectedChatId"></app-chat-window>
  </div>
  <!-- Drag bar per ridimensionare la chat centrale -->
  <div class="resizer" (mousedown)="startResizing($event)"></div>

  <!-- CHAT BLOCK PANEL -->
  <div class="extra-panel box" *ngIf="showRightPanel1">
    <button class="collapse-btn" (click)="showRightPanel1 = false">✖</button>
    <p>📁 Chat Block</p>

    <!-- Campo di ricerca -->
    <input
      class="chat-block-search"
      [(ngModel)]="searchQuery"
      placeholder="🔎 Cerca Chat Block..."
    />

    <!-- Lista dei Chat Block -->
    <div class="chat-block-list">
      <div class="chat-block-item" *ngFor="let block of filteredChatBlocks()">
        <div class="chat-block-header">
          <!-- Nome del Chat Block cliccabile per modifica -->
          <span class="chat-block-name" (click)="editBlock(block)">
            <strong>{{ block.name }}</strong>
          </span>

          <!-- Stella preferito -->
          <button
            class="star-btn"
            (click)="toggleFavorite(block)"
            [title]="
              block.favorite ? 'Rimuovi dai preferiti' : 'Aggiungi ai preferiti'
            "
          >
            {{ block.favorite ? "⭐️" : "☆" }}
          </button>
        </div>

        <!-- Pulsante per inviare direttamente il testo -->
        <button class="send-btn" (click)="sendBlockText(block.text)">
          📩 Invia
        </button>
      </div>
    </div>

    <!-- Bottone per aggiungere un nuovo Chat Block -->
    <button class="new-chat-block-btn" (click)="openNewBlockForm()">
      ➕ Nuovo Chat Block
    </button>

    <!-- Form di creazione/modifica Chat Block -->
    <div *ngIf="showBlockForm" class="chat-block-form">
      <input
        type="text"
        class="chat-block-input"
        [(ngModel)]="blockForm.name"
        placeholder="Nome del Chat Block"
      />

      <textarea
        class="chat-block-textarea"
        [(ngModel)]="blockForm.text"
        placeholder="Testo da inviare..."
      ></textarea>

      <div class="chat-block-form-buttons">
        <button class="save-btn" (click)="saveBlock()">💾 Salva</button>
        <button class="cancel-btn" (click)="cancelBlockForm()">
          ❌ Annulla
        </button>
      </div>
    </div>
  </div>

  <!-- Extra panel 2 -->
  <div class="extra-panel box" *ngIf="showRightPanel2">
    <button class="collapse-btn" (click)="showRightPanel2 = false">✖</button>
    <p>🧰 Altri strumenti</p>
  </div>
</div>

<!-- Bottoni riapertura pannelli -->
<button
  class="reopen-btn"
  *ngIf="!showRightPanel1"
  (click)="showRightPanel1 = true"
>
  ➕ Chat Block
</button>

<button
  class="reopen-btn reopen-btn-secondary"
  *ngIf="!showRightPanel2"
  (click)="showRightPanel2 = true"
>
  ➕ Strumenti
</button>

<!-- Modale Anteprima Messaggio -->
<div class="modal-backdrop" *ngIf="showPreviewModal">
  <div class="modal-content">
    <h3>✉️ Anteprima Messaggio</h3>

    <textarea [(ngModel)]="previewMessage" class="preview-textarea"></textarea>

    <div class="modal-buttons">
      <button class="send-btn" (click)="sendConfirmBlockText()">
        ✅ Invia
      </button>
      <button class="cancel-btn" (click)="showPreviewModal = false">
        ❌ Annulla
      </button>
    </div>
  </div>
</div>
