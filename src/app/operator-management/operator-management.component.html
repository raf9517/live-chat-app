<!-- Container principale della dashboard -->
<div class="management-container">
  <!-- 🧑‍💼 Box Operatori -->
  <section class="operators-section">
    <h2>Operatori</h2>

    <!-- Lista degli operatori con supporto Drag&Drop -->
    <div class="operators-list">
      <div
        class="operator-box"
        *ngFor="let operator of operators"
        cdkDropList
        [cdkDropListConnectedTo]="['chatsToAssignList']"
        [cdkDropListData]="[]"
      >
        <!-- Intestazione dell’operatore -->
        <div class="operator-header">
          <span [ngClass]="operator.online ? 'badge-online' : 'badge-offline'">
            {{ operator.online ? "🟢 Online" : "🔴 Offline" }}
          </span>
          <strong>{{ operator.email }}</strong>
        </div>

        <!-- Numero ticket assegnati -->
        <div class="operator-info">
          Ticket assegnati: {{ countAssignedTickets(operator.uid) }}
        </div>
      </div>
    </div>
  </section>

  <!-- 💬 Box Chat Attive -->
  <section class="active-chats-section">
    <h2>Chat Attive</h2>

    <!-- Azioni in alto: Assegna, Archivia, Elimina -->
    <div class="chat-actions-top">
      <div class="right-controls">
        <!-- Apre il popup per assegnare le chat -->
        <button
          class="small-btn"
          (click)="showAssignModal = true"
          [disabled]="selectedChats.size === 0"
        >
          🎯 Assegna
        </button>

        <!-- Archivia chat selezionate -->
        <button
          class="small-btn"
          (click)="archiveChats()"
          [disabled]="selectedChats.size === 0"
        >
          📦 Archivia
        </button>

        <!-- Elimina (archivia tecnicamente) le chat -->
        <button
          class="small-btn"
          (click)="deleteChats()"
          [disabled]="selectedChats.size === 0"
        >
          🗑 Elimina
        </button>
      </div>
    </div>

    <!-- Seleziona tutte + filtro operatori -->
    <div class="left-controls">
      <!-- ICONA CHECKBOX come label -->
      <label
        for="selectAllCheckbox"
        class="icon-label"
        title="Seleziona tutte le chat"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          height="24px"
          viewBox="0 -960 960 960"
          width="24px"
          fill="#4caf50"
        >
          <path
            d="M280-280v-400h400v400H280Zm80-80h240v-240H360v240ZM200-200v80q-33 0-56.5-23.5T120-200h80Zm-80-80v-80h80v80h-80Zm0-160v-80h80v80h-80Zm0-160v-80h80v80h-80Zm80-160h-80q0-33 23.5-56.5T200-840v80Zm80 640v-80h80v80h-80Zm0-640v-80h80v80h-80Zm160 640v-80h80v80h-80Zm0-640v-80h80v80h-80Zm160 640v-80h80v80h-80Zm0-640v-80h80v80h-80Zm160 640v-80h80q0 33-23.5 56.5T760-120Zm0-160v-80h80v80h-80Zm0-160v-80h80v80h-80Zm0-160v-80h80v80h-80Zm0-160v-80q33 0 56.5 23.5T840-760h-80Z"
          />
        </svg>
      </label>

      <!-- MENU A TRE PUNTINI -->
      <div class="dropdown-container" (clickOutside)="menuOpen = false">
        <button class="ellipsis-btn" (click)="menuOpen = !menuOpen">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            height="24px"
            viewBox="0 -960 960 960"
            width="24px"
            fill="#000000"
          >
            <path
              d="M400-240v-80h160v80H400ZM240-440v-80h480v80H240ZM120-640v-80h720v80H120Z"
            />
          </svg>
        </button>
        <ul class="dropdown-menu" *ngIf="menuOpen">
          <li (click)="setFilter('')">Tutte</li>
          <li (click)="setFilter('waiting')">Solo in attesa</li>
          <li
            *ngFor="let operator of operators"
            (click)="setFilter(operator.uid)"
          >
            {{ operator.email }}
          </li>
        </ul>
      </div>

      <!-- CHECKBOX nascosto visivamente ma attivo -->
      <input
        type="checkbox"
        [checked]="areAllChatsSelected()"
        (change)="toggleSelectAllChats($event)"
        id="selectAllCheckbox"
        style="display: none"
      />
    </div>

    <!-- Lista delle chat attive paginata -->
    <div class="chats-list">
      <div class="chat-box" *ngFor="let chat of paginatedFilteredActiveChats()">
        <!-- Selezione multipla -->
        <input
          type="checkbox"
          (change)="toggleSelection(chat.id)"
          [checked]="selectedChats.has(chat.id)"
        />

        <!-- Info chat -->
        <div class="chat-content">
          <p>
            <strong>{{ chat.id }}</strong>
          </p>
          <p>
            <strong>Assegnata a:</strong>
            {{ findOperatorEmail(chat.assignedTo) }}
          </p>
          <small>
            Ultimo aggiornamento:
            {{ chat.lastUpdated?.toDate() | date : "dd/MM/yyyy HH:mm" }}
          </small>
        </div>
      </div>
    </div>

    <!-- Paginazione -->
    <div class="pagination-controls">
      <label>Mostra:</label>
      <select [(ngModel)]="pageSize" (change)="resetPage()">
        <option [value]="10">10</option>
        <option [value]="20">20</option>
        <option [value]="30">30</option>
      </select>

      <button
        class="small-btn"
        (click)="previousPage()"
        [disabled]="page === 1"
      >
        ⬅️
      </button>
      <span>Pagina {{ page }}</span>
      <button
        class="small-btn"
        (click)="nextPage()"
        [disabled]="!hasNextPage()"
      >
        ➡️
      </button>
    </div>
  </section>

  <!-- 📦 Box Tutte le Chat (da assegnare) -->
  <section class="chats-section">
    <h2>Tutte le Chat</h2>

    <!-- Solo bottone Assegna -->
    <div class="chat-actions-top">
      <div class="left-controls"></div>
      <div class="right-controls">
        <button
          class="small-btn"
          (click)="showAssignModal = true"
          [disabled]="selectedChats.size === 0"
        >
          🎯 Assegna
        </button>
      </div>
    </div>

    <!-- Ricerca per ID -->
    <div class="search-container">
      <input
        type="text"
        placeholder="🔎 Cerca chat per ID..."
        [(ngModel)]="searchTermAssign"
      />
    </div>

    <!-- Lista chat da assegnare -->
    <div class="chats-list">
      <div class="chat-box" *ngFor="let chat of paginatedChatsToAssign()">
        <input
          type="checkbox"
          (change)="toggleSelection(chat.id)"
          [checked]="selectedChats.has(chat.id)"
        />
        <div class="chat-content">
          <p>
            <strong>{{ chat.id }}</strong>
          </p>
          <small>
            Ultimo aggiornamento:
            {{ chat.lastUpdated?.toDate() | date : "dd/MM/yyyy HH:mm" }}
          </small>
        </div>
      </div>
    </div>

    <!-- Paginazione per "Tutte le Chat" -->
    <div class="pagination-controls">
      <label>Mostra:</label>
      <select [(ngModel)]="pageSizeAssign" (change)="resetPageAssign()">
        <option [value]="10">10</option>
        <option [value]="20">20</option>
        <option [value]="30">30</option>
      </select>

      <button
        class="small-btn"
        (click)="previousPageAssign()"
        [disabled]="pageAssign === 1"
      >
        ⬅️
      </button>
      <span>Pagina {{ pageAssign }}</span>
      <button
        class="small-btn"
        (click)="nextPageAssign()"
        [disabled]="!hasNextPageAssign()"
      >
        ➡️
      </button>
    </div>
  </section>
</div>

<!-- ✅ MODALE: Seleziona operatore per assegnazione -->
<div class="modal-overlay" *ngIf="showAssignModal">
  <div class="modal-box">
    <h3>Seleziona un operatore</h3>

    <!-- Selezione dell’operatore dal popup -->
    <select [(ngModel)]="tempSelectedOperator">
      <option value="" disabled selected>Scegli un operatore</option>
      <option *ngFor="let operator of operators" [value]="operator.uid">
        {{ operator.email }}
      </option>
    </select>

    <!-- Azioni nel modale -->
    <div class="modal-actions">
      <!-- Conferma assegnazione: chiama la funzione TS -->
      <button
        class="small-btn primary"
        (click)="assignSelectedChats()"
        [disabled]="!tempSelectedOperator"
      >
        ✅ Conferma
      </button>

      <!-- Annulla e chiude il popup -->
      <button class="small-btn" (click)="showAssignModal = false">
        ❌ Annulla
      </button>
    </div>
  </div>
</div>
